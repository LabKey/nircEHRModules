<script type="text/javascript">

    function importFile(config) {
        var o = {
            schemaName: config.schemaName,
            queryName: config.queryName
        };

        LABKEY.Ajax.request({
            url: LABKEY.ActionURL.buildURL("query", "import", config.containerPath, {
                module: 'nirc_ehr',
                moduleResource: config.moduleResource
            }),
            method: 'POST',
            timeout: 100000,
            success: LABKEY.Utils.getCallbackWrapper(config.success, config.scope),
            failure: LABKEY.Utils.getCallbackWrapper(config.failure, config.scope, true),
            jsonData: o,
            headers: {
                'Content-Type': 'application/json'
            }
        });
    }

    Ext4.onReady(function(){

        var tables = [{
            label: 'Reports',
            populateFn: 'populateFromFile',
            schemaName: 'ehr',
            queryName: 'reports',
            pk: 'rowid'
        }, {
            label: 'Form Templates',
            populateFn: 'populateFormTemplateRecords',
            deleteFn: 'deleteFormTemplateRecords',
            schemaName: 'ehr',
            queryName: 'formtemplates',
            pk: 'entityid'
        }];

        tables.sort(function(a, b) {
            return a.label.toLowerCase() < b.label.toLowerCase() ? -1 : 1;
        });

        var webpart = <%=webpartContext%>;
        Ext4.define('NIRC_EHR.panel.PopulateDataPanel', {
            extend: 'Ext.panel.Panel',

            initComponent: function(){
                Ext4.apply(this, {
                    defaults: {
                        style: 'padding: 10px;'
                    },
                    items: this.getItems()
                });

                this.pendingInserts = 0;
                this.pendingDeletes = 0;

                this.callParent();
            },

            getItems: function(){
                var tableItems = [];
                var items = [{
                    layout: 'hbox',
                    border: false,
                    items: [{
                        border: false,
                        layout: {
                            type: 'table',
                            columns: 2
                        },
                        defaults: {
                            style: 'margin: 2px;'
                        },
                        items: tableItems
                    },{
                        border: false,
                        itemId: 'ehr_msg',
                        xtype: 'box',
                        width: "400px",
                        style: {overflow: "scroll"},
                        html: '<div id="msgbox"></div>'
                    }]
                }];

                Ext4.each(this.tables, function(table){
                    tableItems.push({
                        xtype: 'button',
                        text: 'Populate ' + table.label,
                        scope: this,
                        handler: function(){
                            document.getElementById('msgbox').innerHTML = '<div>Populating ' + table.queryName + '...</div>';
                            if (table.populateFn == 'populateFromFile') {
                                this.populateFromFile.call(this, table.schemaName, table.queryName);
                            } else {
                                this[table.populateFn].call(this);
                            }
                        }
                    });

                    tableItems.push({
                        xtype: 'button',
                        text: 'Delete Data From ' + table.label,
                        scope: this,
                        handler: function(){
                            document.getElementById('msgbox').innerHTML = '<div>Deleting ' + table.label + '...</div>';
                            this.deleteHandler(table);
                        }
                    });
                }, this);

                tableItems.push({
                    xtype: 'button',
                    text: 'Populate All',
                    scope: this,
                    handler: function(){
                        document.getElementById('msgbox').innerHTML = '';
                        Ext4.each(this.tables, function(table){
                            if (!table.doSkip) {
                                document.getElementById('msgbox').innerHTML += '<div>Populating ' + table.queryName + '...</div>';
                                if (table.populateFn == 'populateFromFile') {
                                    this.populateFromFile.call(this, table.schemaName, table.queryName);
                                } else {
                                    this[table.populateFn]();
                                }
                            } else {
                                document.getElementById('msgbox').innerHTML += '<div>Skipping ' + table.label + '</div>';
                            }
                        }, this);
                    }
                });
                tableItems.push({
                    xtype: 'button',
                    text: 'Delete All',
                    scope: this,
                    handler: function(){
                        this.pendingDeletes = 0;
                        document.getElementById('msgbox').innerHTML = '';
                        Ext4.each(this.tables, function(table){
                            if (!table.doSkip) {
                                document.getElementById('msgbox').innerHTML += '<div>Deleting ' + table.label + '...</div>';
                                this.deleteHandler(table);
                            } else {
                                document.getElementById('msgbox').innerHTML += '<div>Skipping ' + table.label + '</div>';
                            }
                        }, this);
                    }
                });

                return items;
            },

            tables: tables,
            deleteHandler: function(table){
                if (table.deleteFn){
                    this[table.deleteFn].call(this);
                }
                else {
                    this.truncate(table.schemaName, table.queryName);
                }
            },

            truncate: function (schemaName, queryName) {
                this.pendingDeletes++;
                LABKEY.Ajax.request({
                    url: LABKEY.ActionURL.buildURL("query", "truncateTable.api"),
                    success: LABKEY.Utils.getCallbackWrapper(this.onDeleteSuccess, this),
                    failure: LDK.Utils.getErrorCallback({
                        callback: function (resp) {
                            document.getElementById('msgbox').innerHTML += '<div class="labkey-error">Error loading data: ' + resp.errorMsg + '</div>';
                        },
                        scope: this
                    }),
                    jsonData: {
                        schemaName: schemaName,
                        queryName: queryName
                    },
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
            },

            onDeleteSuccess: function(data){
                var count = data ? (data.affectedRows || data.deletedRows) : '?';
                this.pendingDeletes--;
                if (this.pendingDeletes === 0){
                    document.getElementById('msgbox').innerHTML += '<div>Delete Complete</div>';
                }
            },

            populateFromFile: function (schemaName, queryName) {
                this.pendingInserts++;
                //records for task forms:
                var config = {
                    schemaName: schemaName,
                    queryName: queryName,
                    moduleResource: '/data/' + queryName + '.tsv',
                    success: this.onSuccess,
                    failure: this.onError,
                    scope: this
                };

                importFile(config);
            },

            populateFormTemplateRecords: function() {
                var formTemplateRows = [{
                    category: "Section",
                    formtype: "blood",
                    title: "1.1ML CLOT (for CHEM)",
                    json: {"tube_vol":1.1,"num_tubes":1,"quantity":1.1,"unit_code":"ML","spm_code":"CLOTTED BLOOD","instructions":"for CHEM"}
                },{
                    category: "Section",
                    formtype: "blood",
                    title: "1.1ML CLOT (for CHEM12)",
                    json: {"tube_vol":1.1,"num_tubes":1,"quantity":1.1,"unit_code":"ML","spm_code":"CLOTTED BLOOD","instructions":"for CHEM12"}
                },{
                    category: "Section",
                    formtype: "blood",
                    title: "4.9ML CLOT",
                    json: {"tube_vol":4.9,"num_tubes":1,"quantity":4.9,"unit_code":"ML","spm_code":"CLOTTED BLOOD"}
                },{
                    category: "Section",
                    formtype: "blood",
                    title: "1.2ML EDTA",
                    json: {"tube_vol":1.2,"num_tubes":1,"quantity":1.2,"unit_code":"ML","spm_code":"EDTA BLOOD"}
                },{
                    category: "Section",
                    formtype: "blood",
                    title: "1.2ML EDTA (for CBC)",
                    json: {"tube_vol":1.2,"num_tubes":1,"quantity":1.2,"unit_code":"ML","spm_code":"EDTA BLOOD","instructions":"for CBC"}
                },{
                    category: "Section",
                    formtype: "blood",
                    title: "4.9ML EDTA (tubes provided)",
                    json: {"tube_vol":4.9,"num_tubes":1,"quantity":4.9,"unit_code":"ML","spm_code":"EDTA BLOOD","instructions":"tubes provided"}
                },{
                    category: "Section",
                    formtype: "blood",
                    title: "2 X 4.9ML EDTA (tubes provided)",
                    json: {"tube_vol":4.9,"num_tubes":2,"quantity":9.8,"unit_code":"ML","spm_code":"EDTA BLOOD","instructions":"tubes provided"}
                },{
                    category: "Section",
                    formtype: "blood",
                    title: "7.5ML EDTA (tubes provided)",
                    json: {"tube_vol":7.5,"num_tubes":1,"quantity":7.5,"unit_code":"ML","spm_code":"EDTA BLOOD","instructions":"tubes provided"}
                },{
                    category: "Section",
                    formtype: "blood",
                    title: "2 X 7.5ML EDTA (tubes provided)",
                    json: {"tube_vol":7.5,"num_tubes":2,"quantity":15.0,"unit_code":"ML","spm_code":"EDTA BLOOD","instructions":"tubes provided"}
                },{
                    category: "Section",
                    formtype: "blood",
                    title: "2 X 2.6ML NA Heparin (tubes provided)",
                    json: {"tube_vol":2.6,"num_tubes":2,"quantity":5.2,"unit_code":"ML","spm_code":"HEPARINIZED BLOOD","instructions":"tubes provided"}
                },{
                    category: "Section",
                    formtype: "prc",
                    title: "CSF (1ML)",
                    json: {"maj_prc_code":"CSF","instruct":"1ML"}
                },{
                    category: "Section",
                    formtype: "prc",
                    title: "Lymph Node Biopsy",
                    json: {"maj_prc_code":"SRG","spm_code":"LYMPH NODE"}
                },{
                    category: "Section",
                    formtype: "prc",
                    title: "Necropsy",
                    json: {"maj_prc_code":"NCR"}
                },{
                    category: "Section",
                    formtype: "prc",
                    title: "Physical Exam",
                    json: {"maj_prc_code":"PHX"}
                },{
                    category: "Section",
                    formtype: "prc",
                    title: "Physical Exam (plus temp)",
                    json: {"maj_prc_code":"PHX","instruct":"plus temp"}
                },{
                    category: "Section",
                    formtype: "prc",
                    title: "Physical Exam (recheck)",
                    json: {"maj_prc_code":"PHX","instruct":"recheck"}
                },{
                    category: "Section",
                    formtype: "prc",
                    title: "Physical Exam (record temp ASAP after anesthesia)",
                    json: {"maj_prc_code":"PHX","instruct":"RECORD TEMP ASAP AFTER ANESTHESIA"}
                },{
                    category: "Section",
                    formtype: "prc",
                    title: "TB Test",
                    json: {"maj_prc_code":"TB","rt_code":"ID"}
                },{
                    category: "Section",
                    formtype: "maintenance",
                    title: "Rake Field Cage",
                    json: {"title": "Rake Field Cage", "instructions": "Please do the following:\n"
                        + "Rake all cages in <ROOM(S)>\n"
                        + "Return daily to <NAME>",
                        "showAnimalDetails":"false", "room": "false", "cage":"false"
                    }
                },{
                    category: "Section",
                    formtype: "maintenance",
                    title: "Breeding Colony Break Room Cleaning",
                    json: {"title": "Breeding Colony Break Room Cleaning", "instructions": "Break room cleaning and maintenance\n"
                        + "* sweep, empty trash, and wipe tables and countertops daily\n"
                        + "* mop floor and clean refrigerator and microwave on Friday",
                        "showAnimalDetails":"false", "room": "false", "cage":"false"
                    }
                },{
                    category: "Section",
                    formtype: "maintenance",
                    title: "Breeding Colony Locker Room Cleaning",
                    json: {"title": "Breeding Colony Locker Room Cleaning", "instructions": "Locker room cleaning and maintenance\n"
                        + "* pick up any clothes lying around and place in hamper, sweep, and empty trash daily\n"
                        + "* mop floor on Thursday",
                        "showAnimalDetails":"false","room": "false","cage":"false"
                    }
                },{
                    category: "Section",
                    formtype: "maintenance",
                    title: "Pathfinder Cleaning",
                    json: {"title": "Pathfinder Cleaning", "instructions": "Pathfinder Cleaning\n"
                        + "* clean the inside and outside of pathfinder on Friday prior to the 1PM vehicle inspection",
                        "showAnimalDetails":"false","room": "false","cage":"false"
                    }
                },{
                    category: "Section",
                    formtype: "maintenance",
                    title: "Van Cleaning",
                    json: {"title": "Van <##> Cleaning", "instructions": "Van <##> cleaning\n"
                        + "* clean the inside and outside of van <##> on Friday prior to the 1PM vehicle inspection",
                        "showAnimalDetails":"false","room": "false","cage":"false"
                    }
                },{
                    category: "Section",
                    formtype: "maintenance",
                    title: "Training",
                    json: {"title": "Training", "instructions": "The following are to attend \"<TITLE>\"\n"
                        + "* when: <TIME>\n* where: <LOCATION>\n* with: <TRAINER>:\n\n<ATTENDEE LIST>",
                        "showAnimalDetails":"false","room": "false","cage":"false"
                    }
                },{
                    category: "Section",
                    formtype: "maintenance",
                    title: "Confirm Ids",
                    json: {
                        "title": "Confirm Ids", "instructions": "Confirm Animal Ids\n"
                        + "* Anesthetize if necessary\n* Contact Heather if there are any problems\n",
                        "showAnimalDetails":"true","room": "true","cage":"true"
                    }
                },{
                    category: "Section",
                    formtype: "maintenance",
                    title: "Quarantine",
                    json: {
                        "title": "Quarantine Animals", "instructions": "<# & species> will arrive <#date>\n"
                        + "* Feed extra fruit for acclimation on the day of arrival\n"
                        + "* Record amount of chow fed and amount of chow remaining the following morning on the daily observation sheets - send copy to Dr. Dufour\n",
                        "showAnimalDetails":"false","room": "true","cage":"true"
                    }
                }];

                this.pendingInserts = 2;

                var formTemplateConfig = {
                    schemaName: 'ehr',
                    queryName: 'formtemplates',
                    rows: formTemplateRows,
                    scope: this,
                    success: function(result, xhr, config) {
                        this.pendingInserts--;

                        var templateTitles = Ext4.Array.pluck(formTemplateRows, 'title');

                        Ext4.each(result.rows, function(row){
                            var index = templateTitles.indexOf(row.title);
                            if (index > -1) {
                                formTemplateRows[index]['templateid'] = row.entityid;
                                formTemplateRows[index]['storeid'] = row.formtype;
                            }
                        }, this);

                        var formTemplateRecordsConfig = {
                            schemaName: 'ehr',
                            queryName: 'formtemplaterecords',
                            rows: formTemplateRows,
                            scope: this,
                            success: this.onSuccess,
                            failure: this.onError
                        };

                        LABKEY.Query.insertRows(formTemplateRecordsConfig);
                    },
                    failure: this.onError
                };
                LABKEY.Query.insertRows(formTemplateConfig);
            },


            deleteFormTemplateRecords: function() {
                //delete from ehr.formtemplaterecords and then ehr.formtemplates
                this.truncate('ehr', 'formtemplaterecords');
                this.truncate('ehr', 'formtemplates');
            },

            onSuccess: function(result, xhr, config){
                if (result.exception || result.errors) {
                    // NOTE: importFile uses query/import.view which returns statusCode=200 for errors
                    this.onError.call(this, result, xhr, config);
                } else {
                    this.pendingInserts--;

                    if (this.pendingInserts === 0) {
                        document.getElementById('msgbox').innerHTML += '<div>Populate Complete</div>';
                    }
                }
            },

            onError: function(result, xhr, config){
                this.pendingInserts--;

                var queryName = result.queryName || config.queryName || config.jsonData.queryName;

                document.getElementById('msgbox').innerHTML += '<div class="labkey-error">ERROR: ' + queryName + ': ' + result.exception + '</div>';

                if (this.pendingInserts==0){
                    document.getElementById('msgbox').innerHTML += '<div>Populate Complete</div>';
                }
            }
        });

        Ext4.create('NIRC_EHR.panel.PopulateDataPanel').render(webpart.wrapperDivId);
    });

</script>
